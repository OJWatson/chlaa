---
title: "Health Economics and Optimisation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Health Economics and Optimisation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

## Why This Workflow?

This vignette demonstrates how epidemiological scenario output can be translated
into decision-facing economic summaries:

1. Explicit assumptions and their sources.
2. Incremental costs and health outcomes versus baseline.
3. CE plane and CEAC visualisations.
4. Constrained budget allocation search.

```{r}
library(chlaa)
library(ggplot2)
set.seed(1)
```

## 1) Build Scenario Runs

```{r}
pars <- chlaa_parameters()
time <- 0:60

scenarios <- list(
  chlaa_scenario("baseline", list()),
  chlaa_scenario("wash_plus_cm", list(
    chlor_start = 10, chlor_end = 60, chlor_effect = 0.2,
    hyg_start = 10, hyg_end = 60, hyg_effect = 0.2,
    orc_start = 10, orc_end = 60, orc_capacity = pars$orc_capacity,
    ctc_start = 10, ctc_end = 60, ctc_capacity = pars$ctc_capacity
  ))
)

runs <- chlaa_run_scenarios(
  pars,
  scenarios,
  time = time,
  n_particles = 40,
  dt = 1,
  seed = 1
)
```

## 2) Economics Assumptions And Source Metadata

Defaults are illustrative and should be replaced in real analyses.

```{r}
econ <- chlaa_econ_defaults()
econ_sources <- chlaa_econ_sources()

head(econ_sources)
```

Published and assumption entries can be filtered separately:

```{r}
subset(econ_sources, source_type == "published")
```

## 3) Incremental Cost-Effectiveness Results

```{r}
cmp <- chlaa_compare_scenarios(
  runs,
  baseline = "baseline",
  include_econ = TRUE,
  econ = econ,
  wtp = 1500
)
cmp
```

```{r}
chlaa_plot_ce_plane(cmp)
```

## 4) CEAC

```{r}
ceac_tbl <- chlaa_ceac(
  runs,
  baseline = "baseline",
  wtp = seq(0, 3000, by = 250),
  econ = econ
)

head(ceac_tbl)
```

```{r}
ggplot(ceac_tbl, aes(x = wtp, y = prob_best, colour = scenario)) +
  geom_line(linewidth = 0.8) +
  labs(
    x = "WTP (USD per DALY averted)",
    y = "Probability cost-effective",
    colour = "Scenario",
    title = "Cost-effectiveness acceptability curves"
  ) +
  theme_minimal()
```

## 5) Budget Allocation Optimisation

```{r}
opt <- chlaa_optimise_budget(
  pars = pars,
  budget = 5e5,
  time = time,
  n_particles = 20,
  dt = 1,
  grid_size = 8,
  min_fraction = list(vax = 0.1),
  max_fraction = list(wash = 0.6),
  max_vax_doses_per_day = 5000
)

opt$best
```

```{r}
ggplot(opt$evaluations, aes(x = budget_vax, y = budget_wash, colour = deaths)) +
  geom_point(size = 2, alpha = 0.8) +
  scale_colour_viridis_c() +
  labs(
    x = "Budget to vaccination",
    y = "Budget to WASH",
    colour = "Expected deaths",
    title = "Budget allocation search surface"
  ) +
  theme_minimal()
```

## Interpretation

These outputs are useful for prioritisation and sensitivity exploration, not as
final procurement estimates. For deployment, replace defaults with local unit
costs, local age structure, and setting-specific YLL assumptions.
