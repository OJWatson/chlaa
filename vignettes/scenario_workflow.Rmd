---
title: "Scenario Workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Scenario Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

## Why This Workflow?

This vignette uses the same shared case-study object as the fitting vignette,
then compares four paper-style intervention scenarios in one coherent view:

1. Baseline response.
2. Anticipatory action.
3. Anticipatory action plus one vaccine dose.
4. Anticipatory action plus two vaccine doses.

```{r}
library(chlaa)
library(ggplot2)
library(dplyr)

case_study <- chlaa_case_study_setup(seed = 42)
pars <- case_study$pars
scenarios <- case_study$scenarios
time <- case_study$time

vapply(scenarios, `[[`, character(1), "name")
```

## 1) Run The Scenario Set

```{r}
runs <- chlaa_run_scenarios(
  pars = pars,
  scenarios = scenarios,
  time = time,
  n_particles = 40,
  dt = 1,
  seed = 1
)
```

## 2) Plot Infection-Rate Trajectories Together

```{r}
plot_df <- runs |>
  group_by(scenario, time) |>
  summarise(infections_per_day = mean(inc_infections), .groups = "drop") |>
  mutate(
    date = case_study$dates$start_date + time,
    infections_k = infections_per_day / 1000
  )

label_map <- c(
  scenario_1_baseline = "Scenario 1: baseline",
  scenario_2_anticipatory_action = "Scenario 2: anticipatory action",
  scenario_3_anticipatory_action_plus_one_vaccine_dose = "Scenario 3: anticipatory action plus one vaccine dose",
  scenario_4_anticipatory_action_plus_two_vaccine_doses = "Scenario 4: anticipatory action plus two vaccine doses"
)

plot_df$scenario_label <- label_map[plot_df$scenario]

trigger_date <- case_study$dates$trigger_date
declaration_date <- case_study$dates$declaration_date

# Style mirrors the paper-like comparison: all scenarios together,
# intervention timing marked, and infection rates shown in thousands/day.
ggplot(plot_df, aes(x = date, y = infections_k, colour = scenario_label, linetype = scenario_label)) +
  geom_line(linewidth = 0.8) +
  geom_vline(xintercept = as.numeric(trigger_date), colour = "grey40") +
  geom_vline(xintercept = as.numeric(declaration_date), colour = "grey40") +
  annotate("text", x = trigger_date, y = max(plot_df$infections_k) * 0.9, label = "AA trigger", angle = 90, vjust = -0.3, size = 3) +
  annotate("text", x = declaration_date, y = max(plot_df$infections_k) * 0.9, label = "Outbreak declaration", angle = 90, vjust = -0.3, size = 3) +
  scale_colour_manual(values = c(
    "Scenario 1: baseline" = "#7f0000",
    "Scenario 2: anticipatory action" = "#b04a2f",
    "Scenario 3: anticipatory action plus one vaccine dose" = "#7d2d2d",
    "Scenario 4: anticipatory action plus two vaccine doses" = "#c15a40"
  )) +
  scale_linetype_manual(values = c(
    "Scenario 1: baseline" = "solid",
    "Scenario 2: anticipatory action" = "11",
    "Scenario 3: anticipatory action plus one vaccine dose" = "dotted",
    "Scenario 4: anticipatory action plus two vaccine doses" = "longdash"
  )) +
  labs(
    x = "Date",
    y = "Infection rate (persons/day x 10^3)",
    colour = "Intervention scenario",
    linetype = "Intervention scenario",
    title = "Scenario infection-rate trajectories"
  ) +
  theme_minimal()
```

## 3) Plot Differences Versus Baseline

```{r}
chlaa_plot_difference_vs_baseline(
  runs,
  baseline = "scenario_1_baseline",
  var = "inc_infections",
  cumulative = FALSE
)
```

```{r}
chlaa_plot_difference_vs_baseline(
  runs,
  baseline = "scenario_1_baseline",
  var = "inc_infections",
  cumulative = TRUE
)
```

## 4) Decision-Facing Summary Tables

```{r}
summary_tbl <- chlaa_scenario_summary(runs, baseline = "scenario_1_baseline", incidence_var = "inc_infections")
summary_tbl
```

```{r}
cmp <- chlaa_compare_scenarios(
  runs,
  baseline = "scenario_1_baseline",
  include_econ = TRUE,
  wtp = 1500
)
cmp
```

## Interpretation

Using one shared case-study context across workflows makes differences easier to
interpret: fitting explains parameter plausibility, scenario analysis explains
epidemiological trade-offs, and economics (next vignette) explains resource
trade-offs for the same intervention set.
