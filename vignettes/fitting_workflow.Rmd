---
title: "Fitting Workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fitting Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

## Why This Workflow?

All package vignettes in this release use the same shared synthetic case study
built by `chlaa_case_study_setup()`, so readers can compare fitting,
intervention scenarios, and economics on a common outbreak context.

The setup is paper-aligned in broad terms (population scale, trigger/declaration
cadence, and vaccine dose quantities) and designed to show a realistic
multi-wave trajectory.

```{r}
library(chlaa)
library(ggplot2)

case_study <- chlaa_case_study_setup(seed = 42)
example_data <- case_study$data

head(example_data)
```

## 1) Visualise The Shared Outbreak Data

```{r}
ggplot(example_data, aes(x = date, y = cases)) +
  geom_line(linewidth = 0.5, colour = "black") +
  labs(
    x = "Date",
    y = "Reported cholera cases/day",
    title = "Shared synthetic outbreak data used across all vignettes"
  ) +
  theme_minimal()
```

## 2) Prepare Data And Starting Parameters

To keep vignette runtime practical on CI, we fit an early-to-mid outbreak
window and reserve later dynamics for scenario/economic workflows.

```{r}
fit_data_raw <- subset(example_data, date <= as.Date("2023-06-30"))
fit_data <- chlaa_prepare_data(fit_data_raw, time_col = "time", cases_col = "cases")

pars_start <- case_study$pars
pars_start$contact_rate <- pars_start$contact_rate * 0.92
pars_start$trans_prob <- pars_start$trans_prob * 1.08
pars_start$reporting_rate <- pars_start$reporting_rate * 0.92
```

## 3) Fit With pMCMC

```{r}
fit <- chlaa_fit_pmcmc(
  data = fit_data,
  pars = pars_start,
  n_particles = 60,
  n_steps = 260,
  seed = 42,
  proposal_var = 1e-5
)
fit
```

## 4) Diagnostics

```{r}
fit_report <- chlaa_fit_report(fit, burnin = 0.25, thin = 2)
fit_report$acceptance_rate
```

```{r}
chlaa_plot_trace(
  fit,
  parameters = c("trans_prob", "contact_rate", "reporting_rate", "obs_size"),
  burnin = 0.25,
  thin = 2
)
```

```{r}
chlaa_plot_likelihood_trace(fit, burnin = 0.25, thin = 2)
```

```{r}
chlaa_plot_parameter_pairs(
  fit,
  parameters = c("trans_prob", "contact_rate", "reporting_rate", "obs_size"),
  burnin = 0.25,
  thin = 2,
  max_points = 1500
)
```

```{r}
chlaa_plot_parameter_vs_likelihood(
  fit,
  parameters = c("trans_prob", "contact_rate", "reporting_rate"),
  burnin = 0.25,
  thin = 2,
  max_points = 1500
)
```

## 5) Posterior Predictive Projection

```{r}
forecast_time <- case_study$time

fc <- chlaa_forecast_from_fit(
  fit = fit,
  pars = pars_start,
  time = forecast_time,
  vars = "inc_symptoms",
  include_cases = TRUE,
  quantiles = c(0.025, 0.125, 0.25, 0.5, 0.75, 0.875, 0.975),
  n_draws = 80,
  burnin = 0.25,
  thin = 2,
  seed = 42,
  dt = 1,
  n_particles = 1
)

f_cases <- fc[fc$variable == "cases", ]
f_cases$date <- case_study$dates$start_date + f_cases$time

obs <- example_data

# Overlay style mirrors the narrative used in the paper figures:
# historical line, mean projection, and nested uncertainty bands.
ggplot() +
  geom_line(data = obs, aes(x = date, y = cases, colour = "Historical data"), linewidth = 0.5) +
  geom_line(data = f_cases, aes(x = date, y = mean, colour = "Mean projection"), linewidth = 0.7) +
  geom_line(data = f_cases, aes(x = date, y = q0p25, colour = "50% UI"), linewidth = 0.5) +
  geom_line(data = f_cases, aes(x = date, y = q0p75, colour = "50% UI"), linewidth = 0.5) +
  geom_line(data = f_cases, aes(x = date, y = q0p125, colour = "75% UI"), linewidth = 0.4, linetype = 2) +
  geom_line(data = f_cases, aes(x = date, y = q0p875, colour = "75% UI"), linewidth = 0.4, linetype = 2) +
  geom_line(data = f_cases, aes(x = date, y = q0p025, colour = "95% UI"), linewidth = 0.4) +
  geom_line(data = f_cases, aes(x = date, y = q0p975, colour = "95% UI"), linewidth = 0.4) +
  scale_colour_manual(values = c(
    "Historical data" = "black",
    "Mean projection" = "#2c7f62",
    "50% UI" = "#b88a66",
    "75% UI" = "#8c8c8c",
    "95% UI" = "#9a3b32"
  )) +
  labs(
    x = "Date",
    y = "Reported cholera cases/day",
    colour = NULL,
    title = "Historical data and fitted model projection"
  ) +
  theme_minimal()
```

## Interpretation

This fitting run is intentionally compact to stay CI-friendly while still
showing the full workflow. For substantive analyses, increase chain length,
particles, and number of seeds, and carry posterior uncertainty through
counterfactual and economic decision analysis.
