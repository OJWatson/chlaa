---
title: "Fitting Workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fitting Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

## Why This Workflow?

This vignette demonstrates a full fit-to-forecast cycle with:

1. A synthetic daily outbreak curve that resembles the qualitative pattern often seen in reported cholera surveillance (large first wave, suppression period, then rebound).
2. A lightweight but fully runnable pMCMC fit.
3. Diagnostics that show both parameter behaviour and likelihood behaviour.
4. A forecast plot that overlays historical observations with model uncertainty bands.

The goal is not to replicate any one outbreak exactly, but to show a transparent, reproducible workflow that users can adapt to real surveillance data.

```{r}
library(chlaa)
library(ggplot2)
set.seed(42)
```

## 1) Generate Example Outbreak Data

We generate synthetic data with a strong first wave and a smaller later rebound. The defaults are tuned for an outbreak profile similar in shape to published response analyses.

```{r}
example_data <- chlaa_generate_example_outbreak_data(
  time = 1:330,
  start_date = as.Date("2021-08-01"),
  seed = 42
)

ggplot(example_data, aes(x = date, y = cases)) +
  geom_line(linewidth = 0.5, colour = "black") +
  labs(
    x = "Date",
    y = "Reported cholera cases/day",
    title = "Synthetic historical outbreak series"
  ) +
  theme_minimal()
```

## 2) Prepare Data And Starting Parameters

We keep the input format strict (`time`, `cases`) and use a near-truth start for a stable, fast demo fit.

```{r}
data_fit <- chlaa_prepare_data(example_data, time_col = "time", cases_col = "cases")

pars_start <- attr(example_data, "truth_parameters")
pars_start$contact_rate <- pars_start$contact_rate * 0.9
pars_start$trans_prob <- pars_start$trans_prob * 1.1
pars_start$reporting_rate <- pars_start$reporting_rate * 0.9
```

## 3) Fit With pMCMC

For vignette runtime on CI we use a compact configuration. For real analyses, increase particles and chain length.

```{r}
fit <- chlaa_fit_pmcmc(
  data = data_fit,
  pars = pars_start,
  n_particles = 60,
  n_steps = 220,
  seed = 42,
  proposal_var = 1e-5
)
fit
```

## 4) Summaries And Diagnostics

We inspect acceptance, traces, pairwise posterior geometry, and likelihood trace.

```{r}
fit_report <- chlaa_fit_report(fit, burnin = 0.25, thin = 2)
fit_report$acceptance_rate
```

```{r}
summary_tbl <- chlaa_posterior_summary(fit, burnin = 0.25, thin = 2)
summary_tbl
```

```{r}
chlaa_plot_trace(
  fit,
  parameters = c("trans_prob", "contact_rate", "reporting_rate", "obs_size"),
  burnin = 0.25,
  thin = 2
)
```

```{r}
chlaa_plot_likelihood_trace(fit, burnin = 0.25, thin = 2)
```

```{r}
chlaa_plot_parameter_pairs(
  fit,
  parameters = c("trans_prob", "contact_rate", "reporting_rate", "obs_size"),
  burnin = 0.25,
  thin = 2,
  max_points = 1000
)
```

```{r}
chlaa_plot_parameter_vs_likelihood(
  fit,
  parameters = c("trans_prob", "contact_rate", "reporting_rate"),
  burnin = 0.25,
  thin = 2,
  max_points = 1000
)
```

## 5) Posterior Predictive Fit And Projection

We forecast beyond the observed horizon and plot central tendency plus 50%, 75%, and 95% uncertainty intervals.

```{r}
forecast_time <- 1:400
fc <- chlaa_forecast_from_fit(
  fit = fit,
  pars = pars_start,
  time = forecast_time,
  vars = "inc_symptoms",
  include_cases = TRUE,
  quantiles = c(0.025, 0.125, 0.25, 0.5, 0.75, 0.875, 0.975),
  n_draws = 80,
  burnin = 0.25,
  thin = 2,
  seed = 42,
  dt = 1,
  n_particles = 1
)

f_cases <- fc[fc$variable == "cases", ]
f_cases$date <- as.Date("2021-08-01") + (f_cases$time - 1)
obs <- example_data
obs$date <- as.Date(obs$date)

ggplot() +
  geom_line(data = obs, aes(x = date, y = cases, colour = "Historical data"), linewidth = 0.5) +
  geom_line(data = f_cases, aes(x = date, y = mean, colour = "Mean projection"), linewidth = 0.7) +
  geom_line(data = f_cases, aes(x = date, y = q0p25, colour = "50% UI"), linewidth = 0.5) +
  geom_line(data = f_cases, aes(x = date, y = q0p75, colour = "50% UI"), linewidth = 0.5) +
  geom_line(data = f_cases, aes(x = date, y = q0p125, colour = "75% UI"), linewidth = 0.4, linetype = 2) +
  geom_line(data = f_cases, aes(x = date, y = q0p875, colour = "75% UI"), linewidth = 0.4, linetype = 2) +
  geom_line(data = f_cases, aes(x = date, y = q0p025, colour = "95% UI"), linewidth = 0.4) +
  geom_line(data = f_cases, aes(x = date, y = q0p975, colour = "95% UI"), linewidth = 0.4) +
  scale_colour_manual(values = c(
    "Historical data" = "black",
    "Mean projection" = "#2c7f62",
    "50% UI" = "#b88a66",
    "75% UI" = "#8c8c8c",
    "95% UI" = "#9a3b32"
  )) +
  labs(
    x = "Date",
    y = "No. of cholera cases/day",
    colour = NULL,
    title = "Historical data and fitted model projection"
  ) +
  theme_minimal()
```

## Interpretation

In this synthetic example, the model reproduces the broad outbreak dynamics and uncertainty envelope. On real data, you would next:

1. Run longer chains and multiple seeds.
2. Check convergence diagnostics more formally.
3. Stress-test assumptions (reporting process, intervention windows, and priors).
4. Carry posterior uncertainty through scenario and economic analyses.
